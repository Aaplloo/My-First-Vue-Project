# 高德地图集成说明

## 概述
本项目已成功将原有的图片形式地图替换为高德地图API，保持了所有原有的功能和样式。

## 最新更新
- ✅ 默认隐藏所有静态点（脉冲点、地点标记、水域、道路、热力图）
- ✅ 用户可通过图层控制按钮手动开启需要的图层
- ✅ 地图加载时保持清洁的界面，无干扰元素
- ✅ **所有标记点现在都附着在地图上，跟随地图缩放、平移、旋转**
- ✅ **包括：图层脉冲点、地点标记、表格报警点、设备点、详情窗口**
- ✅ 所有标记点使用真实的地理坐标系统

## 配置步骤

### 1. 获取高德地图API密钥
1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册账号并登录
3. 创建应用，选择"Web端(JS API)"
4. 获取API密钥（Key）

### 2. 配置API密钥
编辑 `src/config/amap.js` 文件，将 `your-amap-key-here` 替换为您的实际API密钥：

```javascript
export const AMAP_CONFIG = {
  API_KEY: '您的实际API密钥', // 替换这里
  // ... 其他配置
}
```

### 3. 安装依赖
项目已自动安装高德地图依赖包：
```bash
npm install @amap/amap-jsapi-loader
```

## 功能特性

### 地图功能
- ✅ 高德地图底图显示
- ✅ 地图缩放、平移、旋转
- ✅ 地图控件（比例尺、工具栏、鹰眼、图层切换、定位）
- ✅ 3D视图模式
- ✅ 清洁的地图界面，无默认干扰元素
- ✅ **所有标记点完全附着在地图上，支持所有地图交互操作**

### 标记点系统
- **图层脉冲点**：使用 `AMap.Marker` 创建，支持脉冲动画效果
- **地点标记**：包含图标和文本标签，使用真实地理坐标
- **报警标记点**：从表格点击时在地图上显示，支持脉冲动画
- **设备标记点**：从表格点击时在地图上显示，包含设备名称标签
- **动态管理**：支持开启/关闭图层时动态添加/清除标记点

### 图层控制
- 🔘 脉冲点：默认关闭，点击开启后显示随机分布的小红点（附着在地图上）
- 🔘 水域：默认关闭，点击开启后显示水域区域
- 🔘 道路：默认关闭，点击开启后显示道路网络
- 🔘 地点标记：默认关闭，点击开启后显示地点标记（附着在地图上）
- 🔘 热力图：默认关闭，点击开启后显示热力图

### 标记点特性
- **真实地理坐标**：所有标记点使用经纬度坐标，精确定位
- **地图附着**：标记点完全附着在地图上，跟随地图操作
- **动态管理**：支持动态添加、清除标记点
- **样式统一**：保持原有的视觉样式和交互效果
- **性能优化**：按需加载，支持大量标记点
- **完全集成**：表格点击、详情窗口都与地图标记点联动

### 保持的原有功能
- ✅ 报警详情窗口
- ✅ 设备详情窗口
- ✅ 报警列表表格
- ✅ 设备列表表格
- ✅ 诊断弹窗
- ✅ 所有筛选和分页功能

### 新增功能
- ✅ 真实地理坐标系统
- ✅ 地图标记点（报警点和设备点）
- ✅ 点击标记点显示详情
- ✅ 地图交互操作
- ✅ 按需显示的图层系统
- ✅ **完全附着的地图标记点系统**
- ✅ **表格与地图标记点的完全联动**

## 技术实现

### 地图初始化
- 使用 `@amap/amap-jsapi-loader` 异步加载高德地图
- 支持插件扩展（比例尺、工具栏等）
- 错误处理和备用方案
- 默认不加载任何静态标记点

### 标记点系统
- **脉冲点**：使用 `AMap.Marker` 创建，支持脉冲动画效果
- **地点标记**：包含图标和文本标签，使用真实地理坐标
- **报警标记点**：从表格数据动态创建，支持脉冲动画
- **设备标记点**：从表格数据动态创建，包含标签
- **动态管理**：支持开启/关闭图层时动态添加/清除标记点
- **坐标转换**：将原有的百分比坐标转换为经纬度坐标

### 表格联动
- **报警表格**：点击行时在地图上显示对应的报警标记点
- **设备表格**：点击行时在地图上显示对应的设备标记点
- **详情窗口**：与地图标记点位置同步
- **标记点管理**：关闭详情时自动清除对应的地图标记点

### 图层管理
- 所有图层默认关闭状态
- 用户主动开启时才加载相应内容
- 支持动态开启/关闭图层
- 保持原有的CSS样式和交互效果

### 坐标转换
- 将原有的百分比坐标转换为经纬度坐标
- 保持标记点的相对位置关系
- 支持地图缩放和移动
- **所有标记点完全附着在地图上**

### 样式保持
- 使用CSS z-index分层管理
- 地图底图位于底层（z-index: 1）
- UI覆盖层位于上层（z-index: 10）
- 保持所有原有样式和交互效果

## 使用说明

### 开启图层
1. 点击地图顶部的"图层"按钮
2. 在弹出的菜单中选择需要显示的图层
3. 图层状态会显示"✓"表示已开启，"○"表示已关闭

### 关闭图层
1. 再次点击已开启的图层选项
2. 图层状态会切换为关闭状态
3. 相应的标记点会自动从地图上清除

### 表格与地图联动
1. **报警表格**：点击任意行，地图上会显示对应的报警标记点
2. **设备表格**：点击任意行，地图上会显示对应的设备标记点
3. **详情窗口**：标记点位置与详情窗口位置同步
4. **关闭详情**：关闭详情窗口时，对应的地图标记点会自动清除

### 地图交互
- **缩放**：所有标记点会跟随地图缩放，保持相对位置
- **平移**：所有标记点会跟随地图移动，始终显示在正确位置
- **旋转**：所有标记点会跟随地图旋转，保持地理坐标关系

## 注意事项

1. **API密钥安全**：请妥善保管您的API密钥，不要提交到公共代码仓库
2. **网络要求**：需要网络连接才能加载高德地图服务
3. **浏览器兼容**：支持现代浏览器，建议使用Chrome、Firefox、Safari等
4. **性能优化**：地图标记点数量较多时，建议实现虚拟化或分页加载
5. **图层控制**：所有图层默认关闭，需要用户主动开启
6. **标记点附着**：所有标记点现在完全附着在地图上，支持所有地图操作
7. **表格联动**：表格点击会在地图上显示对应的标记点，关闭详情时自动清除

## 故障排除

### 地图无法显示
- 检查API密钥是否正确
- 检查网络连接是否正常
- 查看浏览器控制台错误信息

### 图层无法开启
- 检查地图是否已完全加载
- 查看浏览器控制台是否有错误信息
- 确认图层控制按钮是否正常工作

### 标记点位置不准确
- 检查坐标转换逻辑
- 验证经纬度坐标范围
- 调整地图中心点和缩放级别

### 标记点不跟随地图
- 确认标记点是通过高德地图API创建的
- 检查标记点的坐标设置
- 验证地图实例是否正确初始化

### 表格点击无反应
- 检查地图是否已完全加载
- 确认表格数据是否包含地图位置信息
- 查看浏览器控制台是否有错误信息

### 样式显示异常
- 检查CSS z-index设置
- 验证覆盖层定位是否正确
- 确认地图容器尺寸设置

## 更新日志

- v1.0.4: 所有标记点（包括表格中的报警点和设备点）都改为附着在地图上的真实标记点
- v1.0.3: 脉冲点和地点标记改为附着在地图上的真实标记点
- v1.0.2: 默认隐藏所有静态点，优化图层控制系统
- v1.0.1: 集成高德地图API，替换原有图片地图
- 保持所有原有功能和样式
- 新增真实地图交互功能
- 优化坐标系统和标记点显示
- 实现按需显示的图层管理
- **实现完全附着的地图标记点系统**
- **实现表格与地图标记点的完全联动**
